[FILTER]
    Name modify
    Match *
    Add ecs_version 1.2.0
    Add agent_type fluent-bit

[FILTER]
    Name grep
    Match bro.*
    # ===
    # Remove commented log entries
    Exclude log ^#

[FILTER]
    Name parser
    Match bro.dns
    Key_Name log
    Parser bro_dns_parser
    Preserve_Key on
    Reserve_Data on

[FILTER]
    Name modify
    Match bro.*
    Add observer_type bro
    Add event_module bro

# Add/modify DNS-specific fields
[FILTER]
    Name modify
    Match bro.dns
    Add event_dataset bro.dns
    Rename orig_h client_addr
    Rename orig_p client_port
    Rename resp_h server_addr
    Rename resp_p server_port
    Rename rtt duration
    Rename trans_id dns_id
    Rename query dns_question_name
    Rename qclass_name dns_question_class
    Remove qclass
    Rename qtype_name dns_question_type
    Remove qtype
    Rename rcode_name dns_response_code
    Remove rcode

# ECS: Pre-process before nesting
[FILTER]
    Name modify
    Match bro.*
    Rename log log_original
    Rename mac host_mac
    Rename client_addr client_ip
    Rename server_addr server_ip
    Rename host_name host_hostname
    Rename client_fqdn host_name
    Rename domain host_domain
    Rename duration event_duration
    Rename proto network_transport

# Cleanup - remove keys represending IP addresses if value is "-"
[FILTER]
    Name modify
    Match bro.*
    Condition Key_value_equals client_ip -
    Remove_regex client_ip

[FILTER]
    Name modify
    Match bro.*
    Condition Key_value_equals server_ip -
    Remove_regex server_ip

# Cleanup - remove keys represending duration if value is "-"
# Breaks - unmatched log entries are being removed
#[FILTER]
#    Name modify
#    Match bro.*
#    Condition Key_value_equals event_duration -
#    Remove event_duration

# Troubleshooting - remove custom fields
#[FILTER]
#    Name modify
#    Match bro.*
#    Remove_regex zeek_*

# ECS: Nest JSON objects to comply with ECS notation: ECS
[FILTER]
    Name nest
    Match *
    Operation nest
    Wildcard ecs_*
    Nest_under ecs
    Remove_prefix ecs_

# ECS: Nest JSON objects to comply with ECS notation: AGENT
[FILTER]
    Name nest
    Match *
    Operation nest
    Wildcard agent_*
    Nest_under agent
    Remove_prefix agent_

# ECS: Nest JSON objects to comply with ECS notation: EVENT
[FILTER]
    Name nest
    Match *
    Operation nest
    Wildcard event_*
    Nest_under event
    Remove_prefix event_

# ECS: Nest JSON objects to comply with ECS notation: OBSERVER
[FILTER]
    Name nest
    Match *
    Operation nest
    Wildcard observer_*
    Nest_under observer
    Remove_prefix observer_

# ECS: Nest JSON objects to comply with ECS notation: LOG
[FILTER]
    Name nest
    Match *
    Operation nest
    Wildcard log_*
    Nest_under log
    Remove_prefix log_

# ECS: Nest JSON objects to comply with ECS notation: CLIENT
[FILTER]
    Name nest
    Match bro.*
    Operation nest
    Wildcard client_*
    Nest_under client
    Remove_prefix client_

# ECS: Nest JSON objects to comply with ECS notation: SERVER
[FILTER]
    Name nest
    Match bro.*
    Operation nest
    Wildcard server_*
    Nest_under server
    Remove_prefix server_

# ECS: Nest JSON objects to comply with ECS notation: HOST
[FILTER]
    Name nest
    Match bro.*
    Operation nest
    Wildcard host_*
    Nest_under host
    Remove_prefix host_

# ECS: Nest JSON objects to comply with ECS notation: NETWORK
[FILTER]
    Name nest
    Match bro.*
    Operation nest
    Wildcard network_*
    Nest_under network
    Remove_prefix network_

# ECS: Nest JSON objects to comply with ECS notation: DNS.question
[FILTER]
    Name nest
    Match bro.dns
    Operation nest
    Wildcard dns_question_*
    Nest_under question
    Remove_prefix dns_question_

# ECS: Nest JSON objects to comply with ECS notation: DNS.answers
#[FILTER]
#    Name nest
#    Match bro.dns
#    Operation nest
#    Wildcard dns_answers_*
#    Nest_under answers
#    Remove_prefix dns_answers_

# ECS: Parse dns answers via script to handle multiple entries: dns.answers
[FILTER]
    Name    lua
    Match   bro.dns
    Script  bro_dns_parse.lua
    Call    bro_dns_parse_answers

# ECS: Parse dns flags via script to combine multiple flags into one vector[string]
[FILTER]
    Name    lua
    Match   bro.dns
    Script  bro_dns_parse.lua
    Call    bro_dns_parse_flags

# Remove no longer needed keys
[FILTER]
    Name modify
    Match bro.dns
    Remove answers
    Remove TTLs

# ECS: Nest JSON objects to comply with ECS notation: DNS
[FILTER]
    Name nest
    Match bro.dns
    Operation nest
    Wildcard dns_*
    Wildcard question*
    Nest_under dns
    Remove_prefix dns_

    

